// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Label {
  labelid       Int      @id @default(autoincrement())
  labelName     String   @unique
  Model         Model?   @relation(fields: [modelsModelid], references: [modelid])
  Dataset       Dataset? @relation(fields: [datasetId], references: [id])
  modelsModelid Int?
  datasetId     Int?
}

model Model {
  modelid       Int       @id @default(autoincrement())
  modelName     String    @unique
  label_list    Label[]
  description   String    @default("this is a model for testing")
  downloadCount Int       @default(0)
  lastUpdate    DateTime  @default(now())
  starCount     Int       @default(0)
  Tasks         Task[]
  Comment       Comment[]
  ScoreObj      Float     @default(0.0) // 平均客观题得分
  ScoreSub      Float     @default(0.0) // 平均主观题得分
}

model Dataset {
  id                   Int                   @id @default(autoincrement())
  datasetName          String
  description          String                @default("this is a dataset for task")
  sizeInMB             Float
  lastUpdate           DateTime
  starCount            Int                   @default(0)
  downloadCount        Int                   @default(0)
  label_list           Label[]
  questionType         Int // 0: choice, 1: short answer
  ChoiceQuestions      ChoiceQuestion[]
  ShortAnswerQuestions ShortAnswerQuestion[]
  userId               String // the user who upload the dataset,get from auth() in CLERK
  username             String                @default("Administrator")
  Tasks                Task[]
  Comment              Comment[]
}

model ChoiceQuestion {
  id            Int      @id @default(autoincrement())
  question      String   @db.Text
  choices       Choice[]
  correctAnswer String
  Dataset       Dataset? @relation(fields: [datasetId], references: [id])
  datasetId     Int?
}

model ShortAnswerQuestion {
  id           Int      @id @default(autoincrement())
  question     String   @db.Text
  sampleAnswer String   @db.Text
  Dataset      Dataset? @relation(fields: [datasetId], references: [id])
  datasetId    Int?
}

model Choice {
  id               Int             @id @default(autoincrement())
  content          String          @db.Text
  ChoiceQuestion   ChoiceQuestion? @relation(fields: [choiceQuestionId], references: [id])
  choiceQuestionId Int?
}

model Task {
  id           Int       @id @default(autoincrement())
  userId       String
  taskName     String
  startTime    DateTime  @default(now())
  endTime      DateTime?
  questionType Int // 0: ChoiceQuestion, 1: ShortAnswerQuestion
  modelIds     Json
  models       Model[]
  datasetId    Int
  dataset      Dataset   @relation(fields: [datasetId], references: [id])
  answerjson   Json      @default("{}")
  state        Int // 0: not start, 1: running, 2: paused, 3: finished
  progress     Float
  scoresjson   Json      @default("{}") // 与模型Id一一对应, 保存每个模型的得分
}

model Comment {
  id          Int      @id @default(autoincrement())
  content     String   @db.Text
  //likeN   Int    @default(0)        //暂时不开发这项功能
  commentTime DateTime @default(now())
  lastUpdate  DateTime @default(now())
  type        Int // 0: model, 1: dataset,maybe add 2: task,3:user in the future
  model       Model?   @relation(fields: [modelId], references: [modelid])
  modelId     Int?
  dataset     Dataset? @relation(fields: [datasetId], references: [id])
  datasetId   Int?
  userId      String
  username    String   @default("Administrator")
}

// { "modelId": 
//  {
//    "questionId": "modelAnswer",
//    ···        
//  }
// }

model Adversarial {
  id         Int       @id @default(autoincrement())
  userId     String
  taskName   String
  startTime  DateTime  @default(now())
  endTime    DateTime?
  modelIds   Json
  datasetId  Int
  taskJson   Json      @default("{}")
  scoresJson Json      @default("{}")
}

model Score {
  id            Int   @id @default(autoincrement())
  taskId        Int?
  adversarialId Int?
  score         Float @default(0.0)
  scoreType     Int // 0: obj, 1: sub, 2: adversarial
  mainModelId   Int
  datasetId     Int
  adModelId     Int?
  correctCount  Int // 回答正确的条目数
  totalCount    Int // 总回答问题次数
}
